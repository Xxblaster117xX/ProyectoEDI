@page "/ModifyDataElement/{DataElementId:int}"
@using Entities.Entidades_Definicion
@inject NavigationManager Navigation
@inject DataElementManager dataElementManager
@rendermode InteractiveServer
@using AppLayer;
@inject DataElementAppService dataElementAppService;
<h3>Modificar Elemento de Dato</h3>

<!--Aparece si en la lista no han mensajes-->
@if (dataElement == null)
{
    <p>No se han podido cargar los mensajes</p>
}
else
{
    <!-- Formulario de modificación de un elemento de dato-->
    <EditForm Model="dataElement" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group">
            <label for="dataElementName" class="form-label fw-bold">Nombre</label>
            <InputText class="form-control" @bind-Value="dataElement.Name" required />
        </div>
        <div class="form-group">
            <label for="dataElementDescription" class="form-label fw-bold">Descripción</label>
            <InputTextArea class="form-control" @bind-Value="dataElement.Description" required />
        </div>
        <div class="form-group">
            <label for="dataElementValueFormat" class="form-label fw-bold">Formato de Valor</label>
            <InputText class="form-control" @bind-Value="dataElement.ValueFormat" required />
        </div>
        <br />
        <button type="submit" class="btn btn-success" style="background-color:red">Guardar Cambios</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancelar</button>
    </EditForm>
}
<!-- Pop up de confirmación cuando se pulsa para guardar un  mensaje-->
@if (showSuccessPopup)
{
    <div class="overlay">
        <div class="popUpConfirmation">
            <h4>Modificación Exitosa</h4>
            <p>El elemento de dato se ha modificado correctamente. ¿Desea volver a la lista?</p>
            <div class="popup-buttons">
                <button class="btn btn-success" @onclick="GoToList">Sí</button>
                <button class="btn btn-secondary" @onclick="StayHere">No</button>
            </div>
        </div>
    </div>
}

@code {
    /// <summary>
    /// Variable id de un dataelement para saber que elemento de dato se va a modificar
    /// </summary>
    [Parameter] public int DataElementId { get; set; }
    /// <summary>
    ///Instanciar un data element
    /// </summary>
    private DataElement dataElement;
    /// <summary>
    /// Variable para manejar el pop up de confirmación
    /// </summary>
    private bool showSuccessPopup = false;

    /// <summary>
    /// Cargar el elemento de dato por su ID al inicializar la página.
    /// </summary>
    protected override void OnInitialized()
    {
        Console.WriteLine($"Cargando elemento de dato con ID {DataElementId}");
        dataElement = dataElementAppService.GetDataElementByCode(DataElementId);
        if (dataElement == null)
        {
            Console.WriteLine($"No se encontró el elemento de dato con ID {DataElementId}");
        }
        else
        {
            Console.WriteLine($"Elemento de dato cargado: {dataElement.Name}");
        }
    }

    /// <summary>
    /// Guardar los cambios realizados en el elemento de dato.
    /// </summary>
    private void HandleValidSubmit()
    {
        dataElementAppService.UpdateDataElement(dataElement);
        showSuccessPopup = true;
    }

    /// <summary>
    /// Redirigir a la lista de elementos de dato.
    /// </summary>
    private void GoToList()
    {
        showSuccessPopup = false;
        Navigation.NavigateTo("/DataElementList?success=modified");
    }

    /// <summary>
    /// Permanecer en la página actual.
    /// </summary>
    private void StayHere()
    {
        showSuccessPopup = false;
    }

    /// <summary>
    /// Cancelar la edición y volver a la lista de elementos de dato.
    /// </summary>
    private void Cancel()
    {
        Navigation.NavigateTo("/DataElementList");
    }
}
