@page "/"
@rendermode InteractiveServer
@using AppLayer
@inject NavigationManager Navigation
@using Entities.Model.Enum
@using Entities.Entidades_Definicion
@inject IJSRuntime JS
@using BusinessLogic.Definition
@inject MessageManager messageManager

<h2>Datos del Mensaje</h2>

<EditForm Model="@this" OnValidSubmit="Create">
    <DataAnnotationsValidator />

    <div class="mb-3">
        <label class="form-label">Tipo del mensaje</label>
        <InputSelect class="form-select" @bind-Value="messageTypeValue">
            <option disabled value="">-- Selecciona un tipo --</option>
            @foreach (var type in Enum.GetValues(typeof(MessageTypeEnum)))
            {
                <option value="@type">@type</option>
            }
        </InputSelect>
    </div>

    <div class="mb-3">
        <label class="form-label">Nombre del mensaje</label>
        <InputText class="form-control" @bind-Value="messageNameValue" placeholder="Introduce el nombre del mensaje" />
    </div>

    <div class="mb-3">
        <label class="form-label">Versión del mensaje</label>
        <InputText class="form-control" @bind-Value="messageVersionValue" placeholder="Introduce la versión del mensaje" />
    </div>

    <div class="mb-3">
        <label class="form-label">Versión de directorio del mensaje</label>
        <InputText class="form-control" @bind-Value="messageDirectoryVersionValue" placeholder="Introduce la versión de directorio del mensaje" />
    </div>

    <div class="mb-3">
        <label class="form-label">Fecha de lanzamiento</label>
        <InputText class="form-control" @bind-Value="messageReleaseValue" placeholder="Introduce la fecha de lanzamiento" />
    </div>

    <button type="submit" id="btn-submit" style="background-color:red">Crear Mensaje</button>
</EditForm>

@if (showPopUpMessage)
{
    <div class="overlay">
        <div class="popUpConfirmation">
            <h4>Mensaje Creado</h4>
            <p>Mensaje creado con éxito. ¿Desea visualizarlo?</p>
            <div class="popup-buttons">
                <button class="btn btn-success" @onclick="HandleConfirm">Aceptar</button>
                <button class="btn btn-secondary" @onclick="HandleCancel">Cancelar</button>
            </div>
        </div>
    </div>
}

@code {
    private static int _currentId = 0;
    private string messageTypeValue = string.Empty;
    private string messageVersionValue = string.Empty;
    private string messageNameValue = string.Empty;
    private string messageDirectoryVersionValue = string.Empty;
    private string messageReleaseValue = string.Empty;
    public bool showPopUpMessage = false;

    private int AutoIncrementId() => ++_currentId;

    private async Task Create()
    {
        if (string.IsNullOrWhiteSpace(messageTypeValue) ||
            string.IsNullOrWhiteSpace(messageVersionValue) ||
            string.IsNullOrWhiteSpace(messageNameValue) ||
            string.IsNullOrWhiteSpace(messageDirectoryVersionValue) ||
            string.IsNullOrWhiteSpace(messageReleaseValue))
        {
            await ShowErrorAlert("Por favor, completa todos los campos.");
            return;
        }

        if (IsMessageNameSimilar(messageNameValue))
        {
            await ShowErrorAlert($"Ya existe un mensaje con el mismo nombre: {messageNameValue}");
            return;
        }

        var message = new Message
            {
                MessageId = AutoIncrementId(),
                MessageType = Enum.Parse<MessageTypeEnum>(messageTypeValue),
                MessageVersion = messageVersionValue,
                MessageName = messageNameValue,
                MessageDirectoryVersion = messageDirectoryVersionValue,
                MessageRelease = messageReleaseValue,
                MessageDescription = "Aquí iría la descripción del mensaje"
            };

        messageManager.AddMessage(message);
        Console.WriteLine($"Mensaje creado: {message.MessageName}");
        showPopUpMessage = true;
    }

    private void HandleConfirm()
    {
        showPopUpMessage = false;
        Navigation.NavigateTo("/MessagesList?success=created");
    }

    private void HandleCancel()
    {
        showPopUpMessage = false;
    }

    private bool IsMessageNameSimilar(string newName)
    {
        return messageManager.GetAllMessages().Any(m =>
            m.MessageName.Equals(newName, StringComparison.OrdinalIgnoreCase));
    }

    private async Task ShowErrorAlert(string message)
    {
        await JS.InvokeVoidAsync("alert", message);
    }
}
